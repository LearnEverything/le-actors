{"initialI18nStore":{"en":{"common":{"__Debug message":"Hi, I am in English ðŸ‡¬ðŸ‡§"}}},"initialLanguage":"en","i18nServerInstance":null,"pageProps":{"pages":[],"filePath":"recipes","source":{"compiledSource":"\"use strict\";\n\nvar _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar layoutProps = {};\nvar MDXLayout = \"wrapper\";\n\nfunction MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h2\", null, \"Magic imports\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Use the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"paths\"), \" property of tsconfig.common.json.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Add an alias in Next's Webpack config\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Add an alias in Jest moduleNameMapper config\")), mdx(\"p\", null, mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.typescriptlang.org/docs/handbook/module-resolution.html\"\n  }, \"Relevant documentation\")), mdx(\"h3\", null, \"Why 2-steps?\"), mdx(\"p\", null, \"Using TypeScript \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"paths\"), \" will only tell TypeScript where to find the code. However, it won't replace your import path at build time.\"), mdx(\"p\", null, \"So, you also need Webpack to actually replace \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"~/components/myComponent\"), \" to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"../../../components/myComponent\"), \".\"), mdx(\"h2\", null, \"Debugging Cypress build\"), mdx(\"p\", null, \"See \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/cypress-io/cypress-webpack-preprocessor\"\n  }, \"Cypress Webpack Preprocessor doc\"), \", it describes a few environment variables useful to debug Cypress build.\"), mdx(\"h2\", null, \"Mock next packages\"), mdx(\"p\", null, \"Use a Webpack alias.\"), mdx(\"h2\", null, \"Connect to multiple graphql API in the frontend\"), mdx(\"h3\", null, \"Schema stitching?\"), mdx(\"p\", null, \"Handling connections to multiple graphQL APIs is the nightmare of the modern frontend developer.\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Your backend team may not be able to provide a unique API either. So you often need a way to do schema stitching client side.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Most documentations about schema stitching (client-side) assume that you own the schema (meaning you can get it locally), and that of course it's written in JS. But real frontend developers, most often, connect to APIs they don't own, probably written in a various set of languages...\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"You can do stitching of remote schemas, but documentation is rather terse.\")), mdx(\"p\", null, \"See \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.graphql-tools.com/docs/remote-schemas/\"\n  }, \"GraphQL tools documentation\"), \" for more infos on remote schemas and stitching.\"), mdx(\"h3\", null, \"Multiple Apollo clients?\"), mdx(\"p\", null, \"No, you don't do that. That messes up everything. EVERYTHING. Cache, optimistic UI, development tools... See the section just below for a cleaner, simpler pattern.\"), mdx(\"h3\", null, \"Smart replacement of the HTTP link\"), mdx(\"p\", null, \"But there is one neat trick that \\\"Adepts of the schema stitch\\\" don't want you to know!\"), mdx(\"p\", null, \"It is described in this article from \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.loudnoises.us/next-js-two-apollo-clients-two-graphql-data-sources-the-easy-way/#comment-4707415813\"\n  }, \"Loud noises\"), \". One user, @naveennazimudeen, proposed an extended version \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.loudnoises.us/next-js-two-apollo-clients-two-graphql-data-sources-the-easy-way/#comment-4707415813\"\n  }, \"in the comments of said article\"), \" to handle N services.\"), mdx(\"p\", null, \"The idea is to use \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.apollographql.com/docs/link/composition/#directional-composition\"\n  }, \"directionnal composition\"), \" from Apollo Link. That's a frightening term to say that you can replace a link depending on the context. Let's see the code:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-js\"\n  }, \"// Using Apollo v2, but it should extend to newer versions\\nimport { split } from \\\"apollo-link\\\"\\n// Compute the HTTP link depending on the context\\nconst getHttpLink = (operation) => {\\n  const service = operation.getContext().service;\\n  let uri= \\\"\\\";\\n  if (!service || service === \\\"main\\\") uri = \\\"http://localhost:3000/api/graphql\\\";\\n  if (service === \\\"user\\\") uri = \\\"http://my-user-service.whatever\\\";\\n  if (service === \\\"vulcan\\\") uri = \\\"http://localhost:3001/graphql\\\"\\n  const link = httpLink(uri);\\n  return link.request(operation);\\n};\\n\\n// Trick to be able to load any number of links using split, by calling a function\\nconst multiUriHttpLink = split(\\n    () => true, // force to call the first (and only) branch of the split\\n    operation => getHttpLink(operation, ctx) // by using a function, we allow to split between any number of links\\n  );\\n\\n// and then in your ApolloClient construction:\\n...\\nlink: from([errorLink, multiUriHttpLink]),\\n...\\n\")), mdx(\"p\", null, \"And then you can swap the service like so:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-js\"\n  }, \"// usage\\nconst { data, loading, error } = useQuery(MY_QUERY, {\\n  context: { service: \\\"service1\\\" },\\n});\\n\")), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Main limitation is that you can call services only one by one.\"), \" This pattern is not the recommended way to call multiple APIs, it has clear limitations. But it does the trick , especially if you need to quickly connect to many 3rd party libraries in isolated parts of your app.\"), mdx(\"p\", null, \"Since we use the same client and only change a link, the Apollo cache is shared between services. DevTools should still work with this approach.\"), mdx(\"h2\", null, \"Test server-only code\"), mdx(\"h3\", null, \"Approach 1: change the \", mdx(\"inlineCode\", {\n    parentName: \"h3\"\n  }, \"testEnvironment\"), \" on the fly\"), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"jsdom\"), \" (=client) is the default \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"testEnvironment\"), \" option for Jest. When testing your app server-specific code,\\nyou may want to use the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"node\"), \" environment.\"), mdx(\"p\", null, \"You can do so for a specific test file by adding this at the top:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-js\"\n  }, \"/**\\n * // @see https://jestjs.io/docs/en/next/configuration#testenvironment-string\\n * @jest-environment node\\n */\\n\")), mdx(\"p\", null, \"Pro: no need to change the config\\nCon: can become tedious, not easy to see server-only tests at first glances\"), mdx(\"h3\", null, \"Approach 2: use 2 separate configs\"), mdx(\"p\", null, \"Define \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"jest.config.server.ts\"), \" like this for example:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-js\"\n  }, \"const baseConfig = require(\\\"./jest.config\\\");\\nmodule.exports = {\\n  ...baseConfig,\\n  testEnvironment: \\\"node\\\",\\n  testMatch: [\\n    (testMatch: [\\n      \\\"**/__tests__/**/*.server.[jt]s?(x)\\\",\\n      \\\"**/?(*.)+(spec|test).server.[tj]s?(x)\\\"\\n    ]),\\n  ],\\n};\\n\")), mdx(\"p\", null, \"Only tests named \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"foobar.test.server.js\"), \" (or ts, etc.) will be matched.\"), mdx(\"p\", null, \"Pro: clean, can handle files per folder or per name using a Regex.\\nCons: using 2 configs => using 2 commands, you need to name your server only test specifically,\\nor to isolate them in a specific folder,\\nmore difficult to compute coverage, more configuration\"), mdx(\"h3\", null, \"Approach 3: use one config with the \", mdx(\"inlineCode\", {\n    parentName: \"h3\"\n  }, \"projects\"), \" options\"), mdx(\"p\", null, \"With the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"projects\"), \" options, you can use 2 different Jest config depending on the file name or location.\\nSo you can use one config for server tests and one for client tests.\"), mdx(\"p\", null, \"Pro: based on a core feature of Jest, will compute coverage correctly\\nCons: you need to name your server specifically or to isolate them in a specific folder\"));\n}\n\n;\nMDXContent.isMDXComponent = true;","renderedOutput":"<style data-emotion=\"css 1sra7t5-MuiTypography-root\">.css-1sra7t5-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:300;font-size:3.75rem;line-height:1.2;letter-spacing:-0.00833em;}</style><h2 class=\"MuiTypography-root MuiTypography-h2 css-1sra7t5-MuiTypography-root\">Magic imports</h2><ul><p>- <style data-emotion=\"css e784if-MuiTypography-root\">.css-e784if-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;}</style><span class=\"MuiTypography-root MuiTypography-body2 css-e784if-MuiTypography-root\">Use the <code>paths</code> property of tsconfig.common.json.</span></p><p>- <style data-emotion=\"css e784if-MuiTypography-root\">.css-e784if-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;}</style><span class=\"MuiTypography-root MuiTypography-body2 css-e784if-MuiTypography-root\">Add an alias in Next&#x27;s Webpack config</span></p><p>- <style data-emotion=\"css e784if-MuiTypography-root\">.css-e784if-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;}</style><span class=\"MuiTypography-root MuiTypography-body2 css-e784if-MuiTypography-root\">Add an alias in Jest moduleNameMapper config</span></p></ul><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\"><style data-emotion=\"css 778kay-MuiLink-root\">.css-778kay-MuiLink-root{-webkit-text-decoration:none;text-decoration:none;}.css-778kay-MuiLink-root:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><style data-emotion=\"css zr39bh-MuiTypography-root-MuiLink-root\">.css-zr39bh-MuiTypography-root-MuiLink-root{margin:0;color:#1976d2;-webkit-text-decoration:none;text-decoration:none;}.css-zr39bh-MuiTypography-root-MuiLink-root:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><a class=\"MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover css-zr39bh-MuiTypography-root-MuiLink-root\" href=\"https://www.typescriptlang.org/docs/handbook/module-resolution.html\">Relevant documentation</a></p><style data-emotion=\"css gepadz-MuiTypography-root\">.css-gepadz-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:3rem;line-height:1.167;letter-spacing:0em;}</style><h3 class=\"MuiTypography-root MuiTypography-h3 css-gepadz-MuiTypography-root\">Why 2-steps?</h3><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">Using TypeScript <code>paths</code> will only tell TypeScript where to find the code. However, it won&#x27;t replace your import path at build time.</p><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">So, you also need Webpack to actually replace <code>~/components/myComponent</code> to <code>../../../components/myComponent</code>.</p><style data-emotion=\"css 1sra7t5-MuiTypography-root\">.css-1sra7t5-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:300;font-size:3.75rem;line-height:1.2;letter-spacing:-0.00833em;}</style><h2 class=\"MuiTypography-root MuiTypography-h2 css-1sra7t5-MuiTypography-root\">Debugging Cypress build</h2><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">See <style data-emotion=\"css 778kay-MuiLink-root\">.css-778kay-MuiLink-root{-webkit-text-decoration:none;text-decoration:none;}.css-778kay-MuiLink-root:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><style data-emotion=\"css zr39bh-MuiTypography-root-MuiLink-root\">.css-zr39bh-MuiTypography-root-MuiLink-root{margin:0;color:#1976d2;-webkit-text-decoration:none;text-decoration:none;}.css-zr39bh-MuiTypography-root-MuiLink-root:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><a class=\"MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover css-zr39bh-MuiTypography-root-MuiLink-root\" href=\"https://github.com/cypress-io/cypress-webpack-preprocessor\">Cypress Webpack Preprocessor doc</a>, it describes a few environment variables useful to debug Cypress build.</p><style data-emotion=\"css 1sra7t5-MuiTypography-root\">.css-1sra7t5-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:300;font-size:3.75rem;line-height:1.2;letter-spacing:-0.00833em;}</style><h2 class=\"MuiTypography-root MuiTypography-h2 css-1sra7t5-MuiTypography-root\">Mock next packages</h2><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">Use a Webpack alias.</p><style data-emotion=\"css 1sra7t5-MuiTypography-root\">.css-1sra7t5-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:300;font-size:3.75rem;line-height:1.2;letter-spacing:-0.00833em;}</style><h2 class=\"MuiTypography-root MuiTypography-h2 css-1sra7t5-MuiTypography-root\">Connect to multiple graphql API in the frontend</h2><style data-emotion=\"css gepadz-MuiTypography-root\">.css-gepadz-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:3rem;line-height:1.167;letter-spacing:0em;}</style><h3 class=\"MuiTypography-root MuiTypography-h3 css-gepadz-MuiTypography-root\">Schema stitching?</h3><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">Handling connections to multiple graphQL APIs is the nightmare of the modern frontend developer.</p><ul><p>- <style data-emotion=\"css e784if-MuiTypography-root\">.css-e784if-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;}</style><span class=\"MuiTypography-root MuiTypography-body2 css-e784if-MuiTypography-root\">Your backend team may not be able to provide a unique API either. So you often need a way to do schema stitching client side.</span></p><p>- <style data-emotion=\"css e784if-MuiTypography-root\">.css-e784if-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;}</style><span class=\"MuiTypography-root MuiTypography-body2 css-e784if-MuiTypography-root\">Most documentations about schema stitching (client-side) assume that you own the schema (meaning you can get it locally), and that of course it&#x27;s written in JS. But real frontend developers, most often, connect to APIs they don&#x27;t own, probably written in a various set of languages...</span></p><p>- <style data-emotion=\"css e784if-MuiTypography-root\">.css-e784if-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;}</style><span class=\"MuiTypography-root MuiTypography-body2 css-e784if-MuiTypography-root\">You can do stitching of remote schemas, but documentation is rather terse.</span></p></ul><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">See <style data-emotion=\"css 778kay-MuiLink-root\">.css-778kay-MuiLink-root{-webkit-text-decoration:none;text-decoration:none;}.css-778kay-MuiLink-root:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><style data-emotion=\"css zr39bh-MuiTypography-root-MuiLink-root\">.css-zr39bh-MuiTypography-root-MuiLink-root{margin:0;color:#1976d2;-webkit-text-decoration:none;text-decoration:none;}.css-zr39bh-MuiTypography-root-MuiLink-root:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><a class=\"MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover css-zr39bh-MuiTypography-root-MuiLink-root\" href=\"https://www.graphql-tools.com/docs/remote-schemas/\">GraphQL tools documentation</a> for more infos on remote schemas and stitching.</p><style data-emotion=\"css gepadz-MuiTypography-root\">.css-gepadz-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:3rem;line-height:1.167;letter-spacing:0em;}</style><h3 class=\"MuiTypography-root MuiTypography-h3 css-gepadz-MuiTypography-root\">Multiple Apollo clients?</h3><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">No, you don&#x27;t do that. That messes up everything. EVERYTHING. Cache, optimistic UI, development tools... See the section just below for a cleaner, simpler pattern.</p><style data-emotion=\"css gepadz-MuiTypography-root\">.css-gepadz-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:3rem;line-height:1.167;letter-spacing:0em;}</style><h3 class=\"MuiTypography-root MuiTypography-h3 css-gepadz-MuiTypography-root\">Smart replacement of the HTTP link</h3><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">But there is one neat trick that &quot;Adepts of the schema stitch&quot; don&#x27;t want you to know!</p><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">It is described in this article from <style data-emotion=\"css 778kay-MuiLink-root\">.css-778kay-MuiLink-root{-webkit-text-decoration:none;text-decoration:none;}.css-778kay-MuiLink-root:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><style data-emotion=\"css zr39bh-MuiTypography-root-MuiLink-root\">.css-zr39bh-MuiTypography-root-MuiLink-root{margin:0;color:#1976d2;-webkit-text-decoration:none;text-decoration:none;}.css-zr39bh-MuiTypography-root-MuiLink-root:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><a class=\"MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover css-zr39bh-MuiTypography-root-MuiLink-root\" href=\"https://www.loudnoises.us/next-js-two-apollo-clients-two-graphql-data-sources-the-easy-way/#comment-4707415813\">Loud noises</a>. One user, @naveennazimudeen, proposed an extended version <a class=\"MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover css-zr39bh-MuiTypography-root-MuiLink-root\" href=\"https://www.loudnoises.us/next-js-two-apollo-clients-two-graphql-data-sources-the-easy-way/#comment-4707415813\">in the comments of said article</a> to handle N services.</p><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">The idea is to use <style data-emotion=\"css 778kay-MuiLink-root\">.css-778kay-MuiLink-root{-webkit-text-decoration:none;text-decoration:none;}.css-778kay-MuiLink-root:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><style data-emotion=\"css zr39bh-MuiTypography-root-MuiLink-root\">.css-zr39bh-MuiTypography-root-MuiLink-root{margin:0;color:#1976d2;-webkit-text-decoration:none;text-decoration:none;}.css-zr39bh-MuiTypography-root-MuiLink-root:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><a class=\"MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover css-zr39bh-MuiTypography-root-MuiLink-root\" href=\"https://www.apollographql.com/docs/link/composition/#directional-composition\">directionnal composition</a> from Apollo Link. That&#x27;s a frightening term to say that you can replace a link depending on the context. Let&#x27;s see the code:</p><pre><code class=\"language-js\">// Using Apollo v2, but it should extend to newer versions\nimport { split } from &quot;apollo-link&quot;\n// Compute the HTTP link depending on the context\nconst getHttpLink = (operation) =&gt; {\n  const service = operation.getContext().service;\n  let uri= &quot;&quot;;\n  if (!service || service === &quot;main&quot;) uri = &quot;http://localhost:3000/api/graphql&quot;;\n  if (service === &quot;user&quot;) uri = &quot;http://my-user-service.whatever&quot;;\n  if (service === &quot;vulcan&quot;) uri = &quot;http://localhost:3001/graphql&quot;\n  const link = httpLink(uri);\n  return link.request(operation);\n};\n\n// Trick to be able to load any number of links using split, by calling a function\nconst multiUriHttpLink = split(\n    () =&gt; true, // force to call the first (and only) branch of the split\n    operation =&gt; getHttpLink(operation, ctx) // by using a function, we allow to split between any number of links\n  );\n\n// and then in your ApolloClient construction:\n...\nlink: from([errorLink, multiUriHttpLink]),\n...\n</code></pre><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">And then you can swap the service like so:</p><pre><code class=\"language-js\">// usage\nconst { data, loading, error } = useQuery(MY_QUERY, {\n  context: { service: &quot;service1&quot; },\n});\n</code></pre><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\"><strong>Main limitation is that you can call services only one by one.</strong> This pattern is not the recommended way to call multiple APIs, it has clear limitations. But it does the trick , especially if you need to quickly connect to many 3rd party libraries in isolated parts of your app.</p><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">Since we use the same client and only change a link, the Apollo cache is shared between services. DevTools should still work with this approach.</p><style data-emotion=\"css 1sra7t5-MuiTypography-root\">.css-1sra7t5-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:300;font-size:3.75rem;line-height:1.2;letter-spacing:-0.00833em;}</style><h2 class=\"MuiTypography-root MuiTypography-h2 css-1sra7t5-MuiTypography-root\">Test server-only code</h2><style data-emotion=\"css gepadz-MuiTypography-root\">.css-gepadz-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:3rem;line-height:1.167;letter-spacing:0em;}</style><h3 class=\"MuiTypography-root MuiTypography-h3 css-gepadz-MuiTypography-root\">Approach 1: change the <code>testEnvironment</code> on the fly</h3><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\"><code>jsdom</code> (=client) is the default <code>testEnvironment</code> option for Jest. When testing your app server-specific code,\nyou may want to use the <code>node</code> environment.</p><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">You can do so for a specific test file by adding this at the top:</p><pre><code class=\"language-js\">/**\n * // @see https://jestjs.io/docs/en/next/configuration#testenvironment-string\n * @jest-environment node\n */\n</code></pre><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">Pro: no need to change the config\nCon: can become tedious, not easy to see server-only tests at first glances</p><style data-emotion=\"css gepadz-MuiTypography-root\">.css-gepadz-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:3rem;line-height:1.167;letter-spacing:0em;}</style><h3 class=\"MuiTypography-root MuiTypography-h3 css-gepadz-MuiTypography-root\">Approach 2: use 2 separate configs</h3><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">Define <code>jest.config.server.ts</code> like this for example:</p><pre><code class=\"language-js\">const baseConfig = require(&quot;./jest.config&quot;);\nmodule.exports = {\n  ...baseConfig,\n  testEnvironment: &quot;node&quot;,\n  testMatch: [\n    (testMatch: [\n      &quot;**/__tests__/**/*.server.[jt]s?(x)&quot;,\n      &quot;**/?(*.)+(spec|test).server.[tj]s?(x)&quot;\n    ]),\n  ],\n};\n</code></pre><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">Only tests named <code>foobar.test.server.js</code> (or ts, etc.) will be matched.</p><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">Pro: clean, can handle files per folder or per name using a Regex.\nCons: using 2 configs =&gt; using 2 commands, you need to name your server only test specifically,\nor to isolate them in a specific folder,\nmore difficult to compute coverage, more configuration</p><style data-emotion=\"css gepadz-MuiTypography-root\">.css-gepadz-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:3rem;line-height:1.167;letter-spacing:0em;}</style><h3 class=\"MuiTypography-root MuiTypography-h3 css-gepadz-MuiTypography-root\">Approach 3: use one config with the <code>projects</code> options</h3><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">With the <code>projects</code> options, you can use 2 different Jest config depending on the file name or location.\nSo you can use one config for server tests and one for client tests.</p><style data-emotion=\"css ahj2mt-MuiTypography-root\">.css-ahj2mt-MuiTypography-root{margin:0;font-family:\"Roboto\",\"Helvetica\",\"Arial\",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class=\"MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root\">Pro: based on a core feature of Jest, will compute coverage correctly\nCons: you need to name your server specifically or to isolate them in a specific folder</p>","scope":{}}},"__N_SSG":true}